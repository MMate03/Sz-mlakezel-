<!DOCTYPE html>
<html lang="hu" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Új Számla Létrehozása</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body style="background: lightgrey">

<nav class="navbar navbar-expand-lg navbar-light shadow" style="background: slategray">
    <div class="container-fluid">

        <button onclick="history.back()" class="btn btn-dark shadow">Vissza</button>



    </div>
</nav>

<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-md-6"> <!-- Keskenyebb űrlap -->
            <h1 class="mb-4 text-center">Új Számla Létrehozása</h1>

            <form th:action="@{/invoices/add}" method="post" id="invoiceForm" novalidate>
                <div class="mb-3 ">
                    <label for="customerName" class="form-label">Ügyfél neve</label>
                    <input type="text" class="form-control shadow" id="customerName" name="customerName" required list="customerList">
                    <datalist id="customerList"></datalist>
                    <div class="invalid-feedback">Az ügyfél neve legalább 3 karakter legyen!</div>
                </div>

                <div class="row ">
                    <div class="col-md-6 mb-3 ">
                        <label for="issueDate" class="form-label">Kibocsátás dátuma</label>
                        <input type="date" class="form-control shadow" id="issueDate" name="issueDate" th:value="${today}" required>
                        <div class="invalid-feedback ">A kibocsátás dátuma nem lehet a jövőben!</div>
                    </div>

                    <div class="col-md-6 mb-3">
                        <label for="dueDate" class="form-label">Fizetési határidő</label>
                        <input type="date" class="form-control shadow" id="dueDate" name="dueDate" required>
                        <div class="invalid-feedback">A fizetési határidő nem lehet a kibocsátás dátuma előtt!</div>
                    </div>
                </div>


                <div class="mb-3">
                    <label for="itemName" class="form-label">Tétel neve</label>
                    <input type="text" class="form-control shadow" id="itemName" name="itemName" required>
                </div>

                <div class="mb-3">
                    <label for="price" class="form-label">Összeg</label>
                    <input type="number" step="0.01" class="form-control shadow" id="price" name="price" required>
                </div>

                <div class="mb-3">
                    <label for="comment" class="form-label">Megjegyzés</label>
                    <textarea class="form-control shadow" id="comment" name="comment"></textarea>
                    <div class="invalid-feedback">A megjegyzés legfeljebb 255 karakter lehet!</div>
                </div>

                <div class="text-center">
                    <button type="submit" class="btn btn-dark shadow">Számla létrehozása</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
    document.getElementById("invoiceForm").addEventListener("submit", function (event) {
        let formValid = true;

        const customerName = document.getElementById("customerName");
        const issueDate = document.getElementById("issueDate");
        const dueDate = document.getElementById("dueDate");
        const comment = document.getElementById("comment");

        const today = new Date().toISOString().split("T")[0];

        if (customerName.value.trim().length < 3) {
            customerName.classList.add("is-invalid");
            formValid = false;
        } else {
            customerName.classList.remove("is-invalid");
        }

        if (issueDate.value && issueDate.value > today) {
            issueDate.classList.add("is-invalid");
            formValid = false;
        } else {
            issueDate.classList.remove("is-invalid");
        }

        if (dueDate.value && issueDate.value && dueDate.value < issueDate.value) {
            dueDate.classList.add("is-invalid");
            formValid = false;
        } else {
            dueDate.classList.remove("is-invalid");
        }

        if (comment.value.length > 255) {
            comment.classList.add("is-invalid");
            formValid = false;
        } else {
            comment.classList.remove("is-invalid");
        }

        if (!formValid) {
            event.preventDefault();
            event.stopPropagation();
        }
    });
</script>
<script>
    const customerInput = document.getElementById("customerName");
    const customerList = document.getElementById("customerList");

    customerInput.addEventListener("input", function () {
        const query = customerInput.value.trim();
        if (query.length < 1) return;

        fetch(`/users/search?query=${query}`)
            .then(response => response.json())
            .then(data => {
                customerList.innerHTML = "";
                data.forEach(name => {
                    const option = document.createElement("option");
                    option.value = name;
                    customerList.appendChild(option);
                });
            })
            .catch(err => console.error("Hiba az autocomplete-ben:", err));
    });
</script>
</body>
</html>
